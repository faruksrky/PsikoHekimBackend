services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_SUPER_PASS:-postgres}
      POSTGRES_DB: postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    restart: unless-stopped

  redis:
    image: redis:7
    command: ["redis-server", "--requirepass", "${REDIS_PASSWORD}"]
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:26.0.0
    command: start
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_SCHEMA: public
      KC_DB_USERNAME: ${KC_DB_USERNAME}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
      KC_DB_URL: ${KC_DB_URL}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: "edge"
    depends_on:
      - postgres
    restart: unless-stopped

  backend:
    build:
      context: .
      dockerfile: ./Dockerfile
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SERVER_PORT: ${SERVER_PORT:-8083}
      DB_URL: ${DB_URL}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
      WEBHOOK_BASE_URL: ${WEBHOOK_BASE_URL}
      WEBHOOK_PATH: ${WEBHOOK_PATH}
      BPMN_SERVICE_URL: ${BPMN_SERVICE_URL:-}
      CAMUNDA_BASE_URL: ${CAMUNDA_BASE_URL:-}
      CAMUNDA_PROCESS_KEY: ${CAMUNDA_PROCESS_KEY:-Process_Patient}
    volumes:
      - ./secrets:/run/secrets:ro
      - ./application-prod.yml:/app/application-prod.yml:ro
    # Expose for quick checks; front it with nginx/ingress in real prod
    ports:
      - "8083:8083"
    depends_on:
      - postgres
      - redis
      - keycloak
    restart: unless-stopped

volumes:
  pgdata:
